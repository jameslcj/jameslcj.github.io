{"tags":[{"name":"javaScript高级程序设计笔记","permalink":"http://blog.hellolc.com/tags/javaScript高级程序设计笔记/","url":"/async/tags/javaScript高级程序设计笔记.json","count":11}],"categories":[],"url":"/async/posts/2017/07/13/客户端检测.json","date":1499909394000,"path":{"year":2017,"month":7,"day":13,"name":"客户端检测"},"title":"客户端检测","permalink":"http://blog.hellolc.com/2017/07/13/客户端检测/","content":"<blockquote>\n<p>因为历史的原因, 每个浏览器都会给自己的ua上添加<code>Mozilla</code>的标识, 来伪装成<code>Mozilla</code>浏览器, 能够让服务器响应, 然后再添加上自己浏览器的内核信息以及版本, 所以只能通过这些信息识别, 而且必须按照一定顺序判断, 才能识别真实的浏览器信息; 识别方法如下:</p>\n</blockquote>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div><div class=\"line\">27</div><div class=\"line\">28</div><div class=\"line\">29</div><div class=\"line\">30</div><div class=\"line\">31</div><div class=\"line\">32</div><div class=\"line\">33</div><div class=\"line\">34</div><div class=\"line\">35</div><div class=\"line\">36</div><div class=\"line\">37</div><div class=\"line\">38</div><div class=\"line\">39</div><div class=\"line\">40</div><div class=\"line\">41</div><div class=\"line\">42</div><div class=\"line\">43</div><div class=\"line\">44</div><div class=\"line\">45</div><div class=\"line\">46</div><div class=\"line\">47</div><div class=\"line\">48</div><div class=\"line\">49</div><div class=\"line\">50</div><div class=\"line\">51</div><div class=\"line\">52</div><div class=\"line\">53</div><div class=\"line\">54</div><div class=\"line\">55</div><div class=\"line\">56</div><div class=\"line\">57</div><div class=\"line\">58</div><div class=\"line\">59</div><div class=\"line\">60</div><div class=\"line\">61</div><div class=\"line\">62</div><div class=\"line\">63</div><div class=\"line\">64</div><div class=\"line\">65</div><div class=\"line\">66</div><div class=\"line\">67</div><div class=\"line\">68</div><div class=\"line\">69</div><div class=\"line\">70</div><div class=\"line\">71</div><div class=\"line\">72</div><div class=\"line\">73</div><div class=\"line\">74</div><div class=\"line\">75</div><div class=\"line\">76</div><div class=\"line\">77</div><div class=\"line\">78</div><div class=\"line\">79</div><div class=\"line\">80</div><div class=\"line\">81</div><div class=\"line\">82</div><div class=\"line\">83</div><div class=\"line\">84</div><div class=\"line\">85</div><div class=\"line\">86</div><div class=\"line\">87</div><div class=\"line\">88</div><div class=\"line\">89</div><div class=\"line\">90</div><div class=\"line\">91</div><div class=\"line\">92</div><div class=\"line\">93</div><div class=\"line\">94</div><div class=\"line\">95</div><div class=\"line\">96</div><div class=\"line\">97</div><div class=\"line\">98</div><div class=\"line\">99</div><div class=\"line\">100</div><div class=\"line\">101</div><div class=\"line\">102</div><div class=\"line\">103</div><div class=\"line\">104</div><div class=\"line\">105</div><div class=\"line\">106</div><div class=\"line\">107</div><div class=\"line\">108</div><div class=\"line\">109</div><div class=\"line\">110</div><div class=\"line\">111</div><div class=\"line\">112</div><div class=\"line\">113</div><div class=\"line\">114</div><div class=\"line\">115</div><div class=\"line\">116</div><div class=\"line\">117</div><div class=\"line\">118</div><div class=\"line\">119</div><div class=\"line\">120</div><div class=\"line\">121</div><div class=\"line\">122</div><div class=\"line\">123</div><div class=\"line\">124</div><div class=\"line\">125</div><div class=\"line\">126</div><div class=\"line\">127</div><div class=\"line\">128</div><div class=\"line\">129</div><div class=\"line\">130</div><div class=\"line\">131</div><div class=\"line\">132</div><div class=\"line\">133</div><div class=\"line\">134</div><div class=\"line\">135</div><div class=\"line\">136</div><div class=\"line\">137</div><div class=\"line\">138</div><div class=\"line\">139</div><div class=\"line\">140</div><div class=\"line\">141</div><div class=\"line\">142</div><div class=\"line\">143</div><div class=\"line\">144</div><div class=\"line\">145</div></pre></td><td class=\"code\"><pre><div class=\"line\">var client = function() &#123;</div><div class=\"line\">  var engine = &#123;</div><div class=\"line\">      // 呈现引擎</div><div class=\"line\">      ie: 0,</div><div class=\"line\">      gecko:0,</div><div class=\"line\">      webkit: 0,</div><div class=\"line\">      khtml:0,</div><div class=\"line\">      opera:0,</div><div class=\"line\">      //其他版本号</div><div class=\"line\">      ver: null</div><div class=\"line\">  &#125;;</div><div class=\"line\">  var browser = &#123;</div><div class=\"line\">      // 浏览器</div><div class=\"line\">      ie: 0,</div><div class=\"line\">      firefox:0,</div><div class=\"line\">      safari:0,</div><div class=\"line\">      konq:0,</div><div class=\"line\">      opera:0,</div><div class=\"line\">      chrome:0,</div><div class=\"line\">      // 其他的版本</div><div class=\"line\">      ver: null</div><div class=\"line\">  &#125;;</div><div class=\"line\">  var system = &#123;</div><div class=\"line\">      win: false,</div><div class=\"line\">      mac: false,</div><div class=\"line\">      xll: false,</div><div class=\"line\">      // 移动设备</div><div class=\"line\">      iphone: false,</div><div class=\"line\">      ipod: false,</div><div class=\"line\">      ipad: false,</div><div class=\"line\">      ios: false,</div><div class=\"line\">      android:false</div><div class=\"line\">      // 游戏系统</div><div class=\"line\">      wii: false,</div><div class=\"line\">      ps: false</div><div class=\"line\">   &#125;;</div><div class=\"line\"></div><div class=\"line\">   var ua = navigator.userAgent.toLowerCase();</div><div class=\"line\">   if(ua.match(/opr\\/([\\d\\.]+)/) || window.opera) &#123;</div><div class=\"line\">       var result = ua.match(/opr\\/([\\d\\.]+)/);</div><div class=\"line\">       engine.ver = browser.ver = result[1];</div><div class=\"line\">       engine.opera = browser.opera = parseFloat(engine.ver);</div><div class=\"line\">       if(window.opera) &#123;</div><div class=\"line\">            engine.ver = browser.ver = window.opera.version();</div><div class=\"line\">            engine.opera = browser.opera = parseFloat(engine.ver);</div><div class=\"line\">        &#125;</div><div class=\"line\">   &#125; else if(/applewebkit\\/(\\S+)/.test(ua)) &#123;</div><div class=\"line\">       engine.ver = RegExp[&quot;$1&quot;];</div><div class=\"line\">       engine.webkit = parseFloat(engine.ver);</div><div class=\"line\">       // 确定是chrome还是safari</div><div class=\"line\">       /*</div><div class=\"line\">        * chrome用户代理字符串</div><div class=\"line\">        * Mozilla/5.0 (Windows NT 6.1; WOW64) AppleWebKit/537.36 (KHTML, like Gecko)</div><div class=\"line\">        * Chrome/42.0.2311.152 Safari/537.36</div><div class=\"line\">        */</div><div class=\"line\">        if(/chrome\\/(\\S+)/.test(ua)) &#123;</div><div class=\"line\">             browser.ver = RegExp[&quot;$1&quot;];</div><div class=\"line\">             browser.chrome = parseFloat(browser.ver);</div><div class=\"line\">        &#125;else if(/version\\/(\\S+)/.test(ua)) &#123;</div><div class=\"line\">             /*</div><div class=\"line\">              * safari用户代理字符串</div><div class=\"line\">              * Mozilla/5.0 (Windows NT 6.1; WOW64) AppleWebKit/534.57.2 (KHTML, like Gecko)</div><div class=\"line\">              * Version/5.1.7 Safari/534.57.2</div><div class=\"line\">              */</div><div class=\"line\">             browser.ver = RegExp[&quot;$1&quot;];</div><div class=\"line\">             browser.safari = parseFloat(browser.ver);</div><div class=\"line\">        &#125;else &#123;</div><div class=\"line\">             //近似地确定版本号</div><div class=\"line\">             var safariVersion = 1;</div><div class=\"line\">             if (engine.webkit &lt; 100)&#123;</div><div class=\"line\">                 safariVersion = 1;</div><div class=\"line\">             &#125; else if (engine.webkit &lt; 312)&#123;</div><div class=\"line\">                 safariVersion = 1.2;</div><div class=\"line\">             &#125; else if (engine.webkit &lt; 412)&#123;</div><div class=\"line\">                 safariVersion = 1.3;</div><div class=\"line\">             &#125; else &#123;</div><div class=\"line\">                 safariVersion = 2;</div><div class=\"line\">             &#125;</div><div class=\"line\">             browser.safari = browser.ver = safariVersion;</div><div class=\"line\">         &#125;</div><div class=\"line\">   &#125;else if (/khtml\\/(\\S+)/.test(ua) || /konqueror\\/([^;]+)/.test(ua))&#123;</div><div class=\"line\">         engine.ver = browser.ver = RegExp[&quot;$1&quot;];</div><div class=\"line\">         engine.khtml = browser.konq =  parseFloat(engine.ver);</div><div class=\"line\"></div><div class=\"line\">   &#125;else if(/rv:([^\\)]+)\\) gecko\\/\\d&#123;8&#125;/.test(ua))&#123;</div><div class=\"line\">         engine.ver = RegExp[&quot;$1&quot;];</div><div class=\"line\">         engine.gecko = parseFloat(engine.ver);</div><div class=\"line\">         /*</div><div class=\"line\">          * firefox的用户代理的字符串</div><div class=\"line\">          * Mozilla/5.0 (Windows NT 6.1; WOW64; rv:38.0)</div><div class=\"line\">          * Gecko/20100101 Firefox/38.0</div><div class=\"line\">          */</div><div class=\"line\">         // 确定是不是firefox</div><div class=\"line\">         if(/firefox\\/(\\S+)/.test(ua)) &#123;</div><div class=\"line\">             browser.ver = RegExp[&quot;$1&quot;];</div><div class=\"line\">             browser.firefox = parseFloat(browser.ver);</div><div class=\"line\">         &#125;</div><div class=\"line\">    &#125;else if (/msie ([^;]+)/.test(ua) || &quot;ActiveXObject&quot; in window)&#123;</div><div class=\"line\">         if(&quot;ActiveXObject&quot; in window) &#123;</div><div class=\"line\">            if(/msie ([^;]+)/.test(ua)) &#123;</div><div class=\"line\">               engine.ver = browser.ver = RegExp[&quot;$1&quot;];</div><div class=\"line\">               engine.ie = browser.ie = parseFloat(engine.ver);</div><div class=\"line\">            &#125;else &#123;</div><div class=\"line\">               if(/rv:([^\\)]+)\\)/.test(ua)) &#123;</div><div class=\"line\">                   engine.ver = browser.ver = RegExp[&quot;$1&quot;];</div><div class=\"line\">                   engine.ie = browser.ie = parseFloat(engine.ver);</div><div class=\"line\">               &#125;</div><div class=\"line\">            &#125;</div><div class=\"line\">         &#125;</div><div class=\"line\"></div><div class=\"line\">    &#125;</div><div class=\"line\">    //检测浏览器</div><div class=\"line\">    browser.ie = engine.id;</div><div class=\"line\">    browser.opera = engine.opera;</div><div class=\"line\">    // 检测平台</div><div class=\"line\">    var platform = navigator.platform;</div><div class=\"line\">    system.win = platform.indexOf(&quot;Win&quot;) == 0;</div><div class=\"line\">    system.mac = platform.indexOf(&quot;Mac&quot;) == 0;</div><div class=\"line\">    system.x11 = (platform.indexOf(&quot;X11&quot;) == 0) || (platform.indexOf(&quot;Linux&quot;) == 0);</div><div class=\"line\"></div><div class=\"line\">    // 移动设备</div><div class=\"line\">    system.iphone = ua.indexOf(&quot;iphone&quot;) &gt; -1;</div><div class=\"line\">    system.ipod = ua.indexOf(&quot;ipod&quot;) &gt; -1;</div><div class=\"line\">    system.ipad = ua.indexOf(&quot;ipad&quot;) &gt; -1;</div><div class=\"line\">    //检测iOS 版本</div><div class=\"line\">    if (system.mac &amp;&amp; ua.indexOf(&quot;mobile&quot;) &gt; -1)&#123;</div><div class=\"line\">         if (/cpu (?:iphone )?os (\\d+_\\d+)/.test(ua))&#123;</div><div class=\"line\">             system.ios = parseFloat(RegExp.$1.replace(&quot;_&quot;, &quot;.&quot;));</div><div class=\"line\">         &#125; else &#123;</div><div class=\"line\">             system.ios = 2; //不能真正检测出来，所以只能猜测</div><div class=\"line\">         &#125;</div><div class=\"line\">     &#125;</div><div class=\"line\">     //检测Android 版本</div><div class=\"line\">     if (/android (\\d+\\.\\d+)/.test(ua))&#123;</div><div class=\"line\">         system.android = parseFloat(RegExp.$1);</div><div class=\"line\">     &#125;</div><div class=\"line\">     system.wii = ua.indexOf(&apos;wii&apos;) &gt; -1;</div><div class=\"line\">     system.ps = /playstation/i.test(ua);</div><div class=\"line\"></div><div class=\"line\">     return &#123;</div><div class=\"line\">       engine: engine,</div><div class=\"line\">       browser: browser,</div><div class=\"line\">       system: system,</div><div class=\"line\">     &#125;</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure>\n"}