{"tags":[{"name":"javaScript高级程序设计笔记","permalink":"http://blog.hellolc.com/tags/javaScript高级程序设计笔记/","url":"/async/tags/javaScript高级程序设计笔记.json","count":17}],"categories":[],"url":"/async/posts/2017/09/18/离线应用与客户端存储.json","date":1505699666000,"path":{"year":2017,"month":9,"day":18,"name":"离线应用与客户端存储"},"title":"离线应用与客户端存储","permalink":"http://blog.hellolc.com/2017/09/18/离线应用与客户端存储/","content":"<h2 id=\"离线检测\"><a href=\"#离线检测\" class=\"headerlink\" title=\"离线检测\"></a>离线检测</h2><blockquote>\n<p><code>navigator.onLine</code>检测浏览器能否访问网络; 也可以监听<code>online</code>, <code>offline</code>事件来获取网络变化情况</p>\n</blockquote>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div></pre></td><td class=\"code\"><pre><div class=\"line\">window.online = function(event) &#123;</div><div class=\"line\"></div><div class=\"line\">&#125;</div><div class=\"line\">window.offline = function(event) &#123;</div><div class=\"line\"></div><div class=\"line\">&#125;</div></pre></td></tr></table></figure>\n<h2 id=\"应用缓存\"><a href=\"#应用缓存\" class=\"headerlink\" title=\"应用缓存\"></a>应用缓存</h2><blockquote>\n<p><code>applicationCache</code>专为离线web设计, <code>applicationCache</code>的status能够检测缓存情况</p>\n</blockquote>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div></pre></td><td class=\"code\"><pre><div class=\"line\">//将缓存与页面关联起来</div><div class=\"line\">&lt;html manifest=&quot;/offline.manifest&quot;&gt;</div><div class=\"line\"></div><div class=\"line\">//缓存状况</div><div class=\"line\">console.log(applicationCache.status);</div><div class=\"line\"></div><div class=\"line\">//监听缓存变化情况</div><div class=\"line\">applicationCache.updateready = function() &#123;</div><div class=\"line\">\tapplicationCache.swapCache();</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure>\n<h2 id=\"cookie\"><a href=\"#cookie\" class=\"headerlink\" title=\"cookie\"></a>cookie</h2><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div></pre></td><td class=\"code\"><pre><div class=\"line\">//查看cookie</div><div class=\"line\">console.log(document.cookie)</div><div class=\"line\"></div><div class=\"line\">//设置cookie</div><div class=\"line\">document.cookie = encodeURIComponent(&quot;test&quot;) + &quot;=&quot; + encodeURIComponent(&quot;value&quot;)</div><div class=\"line\"></div><div class=\"line\">//删除cookie 其实就是让时间过期</div><div class=\"line\">document.cookie = encodeURIComponent(&quot;test&quot;) + &quot;=&quot; + encodeURIComponent(&quot;value&quot;) + &quot;; expires=&quot; + new Date(0)</div></pre></td></tr></table></figure>\n<h3 id=\"子cookie\"><a href=\"#子cookie\" class=\"headerlink\" title=\"子cookie\"></a>子cookie</h3><blockquote>\n<p>每个域设置的cookie是有上限的, 每条长度也有上限, 各浏览器各不一样; 我们可以设置子cookie增加cookie上限</p>\n</blockquote>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div></pre></td><td class=\"code\"><pre><div class=\"line\">//我们可以先获取parent, 先根据&amp;split, 然后通过各sub获取对应的子cookie值</div><div class=\"line\">document.cookie = &quot;parent=sub1=val1&amp;sub2=val2&quot;</div></pre></td></tr></table></figure>\n<h2 id=\"IE用户数据\"><a href=\"#IE用户数据\" class=\"headerlink\" title=\"IE用户数据\"></a>IE用户数据</h2><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div></pre></td><td class=\"code\"><pre><div class=\"line\">var dataStore = document.getElementById(&quot;dataStore&quot;);</div><div class=\"line\">dataStore.setAttribute(&quot;name&quot;, &quot;test&quot;);</div><div class=\"line\">dataStore.setAttribute(&quot;book&quot;, &quot;val&quot;);</div><div class=\"line\">dataStore.save(&quot;bookInfo&quot;);</div><div class=\"line\"></div><div class=\"line\">//下一次加载页面 调用load 即可加载数据</div><div class=\"line\">dataStore.load(&quot;book&quot;)</div><div class=\"line\">//获取</div><div class=\"line\">dataStore.getAttribute(&quot;name&quot;);</div><div class=\"line\">//删除</div><div class=\"line\">dataStore.removeAttribute(&quot;name&quot;)</div></pre></td></tr></table></figure>\n<h2 id=\"数据存储\"><a href=\"#数据存储\" class=\"headerlink\" title=\"数据存储\"></a>数据存储</h2><blockquote>\n<p>浏览器对每个源存储的大小在 2.5M-5M之间</p>\n</blockquote>\n<h3 id=\"storage事件\"><a href=\"#storage事件\" class=\"headerlink\" title=\"storage事件\"></a>storage事件</h3><blockquote>\n<p><code>setItem</code>, <code>clear</code>, <code>removeItem</code>都会触发<code>storage事件</code></p>\n</blockquote>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div></pre></td><td class=\"code\"><pre><div class=\"line\">window.addEventListener(&apos;storage&apos;, function(event) &#123;</div><div class=\"line\">\tconsole.log(event.domain)</div><div class=\"line\">&#125;)</div></pre></td></tr></table></figure>\n<h3 id=\"IndexedDB\"><a href=\"#IndexedDB\" class=\"headerlink\" title=\"IndexedDB\"></a>IndexedDB</h3><h4 id=\"数据库\"><a href=\"#数据库\" class=\"headerlink\" title=\"数据库\"></a>数据库</h4><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div></pre></td><td class=\"code\"><pre><div class=\"line\">//打开一个名为admin的数据库</div><div class=\"line\">var database;</div><div class=\"line\">var request = indexedDB.open(&quot;admin&quot;);</div><div class=\"line\">request.onsuccess = function(event) &#123;</div><div class=\"line\">\tconsole.log(&quot;success&quot;)</div><div class=\"line\">\tdatabase = event.target.result;</div><div class=\"line\">&#125;</div><div class=\"line\">request.onerror = function(event) &#123;</div><div class=\"line\">\tconsole.log(event.target.errorCode)</div><div class=\"line\">&#125;</div><div class=\"line\"></div><div class=\"line\">//给数据库设置版本号, 默认是没有版本号的</div><div class=\"line\">if (database.version != &quot;1.0&quot; &amp;&amp; database.serVersion) &#123;</div><div class=\"line\">\trequest = database.serVersion(&quot;1.0&quot;);</div><div class=\"line\">\trequest.onerror = function(event) &#123;</div><div class=\"line\">\t\tconsole.log(event.target.errorCode);</div><div class=\"line\">\t&#125;</div><div class=\"line\">\trequest.onsuccess = function(event) &#123;</div><div class=\"line\">\t\tconsole.log(database.version)</div><div class=\"line\">\t&#125;</div><div class=\"line\">&#125; else &#123;</div><div class=\"line\">\tconsole.log(database.version)</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure>\n<h4 id=\"对象存储空间\"><a href=\"#对象存储空间\" class=\"headerlink\" title=\"对象存储空间\"></a>对象存储空间</h4><ul>\n<li>database.createObjectStore(表名, 指定主键)</li>\n<li>store.add(obj) 添加数据<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div></pre></td><td class=\"code\"><pre><div class=\"line\">var user = &#123;</div><div class=\"line\">\tusername: &quot;007&quot;,</div><div class=\"line\">\tfirstName: &quot;James&quot;,</div><div class=\"line\">\tlastName: &quot;Bond&quot;,</div><div class=\"line\">\tpassword: &quot;foo&quot;</div><div class=\"line\">&#125;</div><div class=\"line\"></div><div class=\"line\">var store = database.createObjectStore(&quot;users&quot;, &#123;keypath: &quot;username&quot;&#125;)</div><div class=\"line\">store.add(user)</div></pre></td></tr></table></figure>\n</li>\n</ul>\n<h4 id=\"事物\"><a href=\"#事物\" class=\"headerlink\" title=\"事物\"></a>事物</h4><ul>\n<li>database.transaction([表名, …], 访问模式)<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div></pre></td><td class=\"code\"><pre><div class=\"line\">var transaction = database.transaction([&quot;users&quot;, &quot;anotherStore&quot;], READ_WRITE)</div><div class=\"line\">//获取相应的表 获取相应的数据</div><div class=\"line\">transaction.objectStore(&quot;users&quot;).get(&quot;007&quot;)</div></pre></td></tr></table></figure>\n</li>\n</ul>\n<h4 id=\"使用游标查询\"><a href=\"#使用游标查询\" class=\"headerlink\" title=\"使用游标查询\"></a>使用游标查询</h4><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div></pre></td><td class=\"code\"><pre><div class=\"line\">var store = database.transaction([&quot;users&quot;, &quot;anotherStore&quot;], READ_WRITE).objectStore(&quot;users&quot;), value, updateRequest;</div><div class=\"line\">request.onsuccess = function(event) &#123;</div><div class=\"line\">\tvar cursor = event.target.result;</div><div class=\"line\">\tif (cursor) &#123;</div><div class=\"line\">\t\tif (cursor.key == &quot;foo&quot;) &#123;</div><div class=\"line\">\t\t\tvalue = cursor.value;</div><div class=\"line\">\t\t\tvalue.password = &quot;magic&quot;</div><div class=\"line\"></div><div class=\"line\">\t\t\tupdateRequest = cursor.update(value);</div><div class=\"line\">\t\t\tupdateRequest.onsuccess = function() &#123;&#125;</div><div class=\"line\">\t\t\tupdateRequest.onerror = function() &#123;&#125;</div><div class=\"line\">\t\t&#125;</div><div class=\"line\">\t\t//游标移动到下一个</div><div class=\"line\">\t\tcursor.continue();</div><div class=\"line\">\t&#125;</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure>\n<h4 id=\"键范围\"><a href=\"#键范围\" class=\"headerlink\" title=\"键范围\"></a>键范围</h4><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div></pre></td><td class=\"code\"><pre><div class=\"line\">var IDBKeyRange = window.IDBKeyRange</div><div class=\"line\"></div><div class=\"line\">//和上面的get(&quot;007&quot;) 功能类似</div><div class=\"line\">IDBKeyRange.only(&quot;007&quot;)</div></pre></td></tr></table></figure>\n<h4 id=\"并发问题\"><a href=\"#并发问题\" class=\"headerlink\" title=\"并发问题\"></a>并发问题</h4><blockquote>\n<p>当同一个来源的另一个标签页调用<code>setVersion()</code>时, 会触发<code>onversionchange</code>事件, 我们此时需要立即将数据库, 这样另一个页面的执行才能成功, 因为只有一个标签页使用数据库才能修改版本, 如果有其他tab开着数据库导致改变版本失败, 会触发<code>onblock</code>事件</p>\n</blockquote>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div></pre></td><td class=\"code\"><pre><div class=\"line\">var database;</div><div class=\"line\">var request = indexedDB.open(&quot;admin&quot;);</div><div class=\"line\">request.onsuccess = function(event) &#123;</div><div class=\"line\">\tconsole.log(&quot;success&quot;)</div><div class=\"line\">\tdatabase = event.target.result;</div><div class=\"line\"></div><div class=\"line\">\tdatabase.onversionchange = function() &#123;</div><div class=\"line\">\t\tdatabase.close()</div><div class=\"line\">\t&#125;</div><div class=\"line\"></div><div class=\"line\">\tdatabase.onblock = function() &#123;</div><div class=\"line\">\t\talert(&quot;请先关闭其他tab的数据库&quot;)</div><div class=\"line\">\t&#125;</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure>\n<h4 id=\"限制\"><a href=\"#限制\" class=\"headerlink\" title=\"限制\"></a>限制</h4><blockquote>\n<p>数据库也是有大小限制的, 根据每个浏览器而不同, 大小在5mb-50mb之间</p>\n</blockquote>\n"}