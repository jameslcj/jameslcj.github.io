{"tags":[{"name":"You Don't Know JS","permalink":"http://blog.hellolc.com/tags/You-Don-t-Know-JS/","url":"/async/tags/You Don't Know JS.json","count":5}],"categories":[],"url":"/async/posts/2017/12/02/Generators.json","date":1512195421000,"path":{"year":2017,"month":12,"day":2,"name":"Generators"},"title":"Generators","permalink":"http://blog.hellolc.com/2017/12/02/Generators/","content":"<h2 id=\"迭代器\"><a href=\"#迭代器\" class=\"headerlink\" title=\"迭代器\"></a>迭代器</h2><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">function *foo(x) &#123;</span><br><span class=\"line\">\tvar y = x * (yield function() &#123;return &quot;hello world&quot;;&#125;); </span><br><span class=\"line\">\treturn y;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">var it = foo( 6 ); //将6作为参数调用foo方法 并返回一个迭代器对象</span><br><span class=\"line\">// start `foo(..)`</span><br><span class=\"line\">var res1 = it.next(); //开始执行函数, 直到碰到yield 就停住了, 等待下一步指令; 并返回一个迭代器对象值为 &#123;done: false, value: ƒ&#125;, done表示迭代器还没有结束, value表示yield后面的内容; 一般浏览器都会忽略掉第一个next传入的参数</span><br><span class=\"line\">res1.value(); //上面yield后面的内容是一个函数, 所以调用后, 返回&quot;hello world&quot;</span><br><span class=\"line\">var res2 = it.next( 7 ); //将7 作为yield的返回值, 并继续执行至下一个yield或是结束</span><br><span class=\"line\">res2.value; //因此 6 * 7 = 42</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">function* test() &#123;</span><br><span class=\"line\">\tyield 1;</span><br><span class=\"line\">\tyield 2;</span><br><span class=\"line\">\tyield 3;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">var it = test();</span><br><span class=\"line\">for (var v of it) &#123;</span><br><span class=\"line\">\tconsole.log(v)</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<blockquote>\n<p><code>for (var v of it)</code> 会自动执行迭代器的next方法, 直到返回的对象<code>done: true</code></p>\n</blockquote>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">for (var v of it) &#123;&#125;</span><br><span class=\"line\">//可以转化为如下</span><br><span class=\"line\">for (var ret; (ret = it.next()) &amp;&amp; !ret.done; ) &#123;&#125;</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">var arr = [1, 3, 5, 7];</span><br><span class=\"line\">for (var v of arr) &#123;</span><br><span class=\"line\">\tconsole.log(v);//1 3 5 7</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">// 等价于如下</span><br><span class=\"line\">var it = arr[Symbol.iterator]()</span><br><span class=\"line\">it.next();//&#123;value: 1, done: false&#125;</span><br><span class=\"line\">it.next();//&#123;value: 3, done: false&#125;</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">function* test() &#123;</span><br><span class=\"line\">\ttry &#123;</span><br><span class=\"line\">\t\tvar nextVal = 1;</span><br><span class=\"line\">\t\twhile (true) &#123;</span><br><span class=\"line\">\t\t\tnextVal += 3;</span><br><span class=\"line\">\t\t\tyield nextVal;</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t&#125; finally &#123;</span><br><span class=\"line\">\t\tconsole.log(&apos;finally...&apos;)</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">var it = test();</span><br><span class=\"line\">for (var v of it) &#123;</span><br><span class=\"line\">\tconsole.log(v)</span><br><span class=\"line\">\tif (v &gt; 30 ) &#123;</span><br><span class=\"line\">\t\tvar result = it.return(&quot;hello world&quot;)</span><br><span class=\"line\">\t\tconsole.log(&quot;result: &quot;, result)</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">/**</span><br><span class=\"line\"> * 输出结果: 1 4 .... finally... result: &#123;value: &quot;hello world&quot;, done: true&#125;</span><br><span class=\"line\"> */</span><br></pre></td></tr></table></figure>\n<blockquote>\n<p>当我们调用迭代器it的return方法时, 迭代器会将it.next的结果done设置为true, 来终端迭代器迭代下去, 然后会执行迭代器里的finally方法(如果有), 最后返回的value的值等于我们return传递进去的值</p>\n</blockquote>\n<h2 id=\"自动执行迭代器\"><a href=\"#自动执行迭代器\" class=\"headerlink\" title=\"自动执行迭代器\"></a>自动执行迭代器</h2><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">function ajax(delay) &#123;</span><br><span class=\"line\">    return new Promise(function(resolve, reject) &#123;</span><br><span class=\"line\">        //延迟返回 模拟异步</span><br><span class=\"line\">        setTimeout(() =&gt; &#123;</span><br><span class=\"line\">            resolve(&quot;ajax data&quot;);</span><br><span class=\"line\">        &#125;, delay)</span><br><span class=\"line\">    &#125;)</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">function *test(arg) &#123;</span><br><span class=\"line\">    var ajaxRes = yield ajax(arg);</span><br><span class=\"line\">    return yield ajaxRes;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">/**</span><br><span class=\"line\"> * 模拟co库写的一个迭代器递归执行方法</span><br><span class=\"line\"> **/</span><br><span class=\"line\">function co(gen) &#123;</span><br><span class=\"line\">    //获取初始化参数</span><br><span class=\"line\">    var args = [].slice.call(arguments, 1);</span><br><span class=\"line\">    //使用当前作用域初始化gen获取迭代器对象it, 下面it会作为一个闭包对象一直被递归调用</span><br><span class=\"line\">    var it = gen.apply(this, args);</span><br><span class=\"line\">    //返回一个处理好的promise</span><br><span class=\"line\">    return Promise.resolve().then(function handleNext(value) &#123;</span><br><span class=\"line\">        //将上一次promise返回的结果作为参数传递给迭代器, 第一次value为undefined, 一般浏览器会忽略</span><br><span class=\"line\">        var next = it.next(value);</span><br><span class=\"line\">        console.log(&quot;next: &quot;, next);</span><br><span class=\"line\">        </span><br><span class=\"line\">        //函数自运行</span><br><span class=\"line\">        return (function handleResult(next) &#123;</span><br><span class=\"line\">            //判断迭代器是否完成 如果完成返回最后结果</span><br><span class=\"line\">            if (next.done) &#123;</span><br><span class=\"line\">                return next.value;</span><br><span class=\"line\">            &#125; else if (typeof next.value == &apos;function&apos;) &#123;</span><br><span class=\"line\">\t\t\t\t//处理thunk类型的回调</span><br><span class=\"line\">\t\t\t\t//返回一个promise</span><br><span class=\"line\">\t\t\t\treturn new Promise(function(resolve, reject) &#123;</span><br><span class=\"line\">\t\t\t\t\t//给thunk传递回调函数</span><br><span class=\"line\">\t\t\t\t\tnext.value(function(err, msg) &#123;</span><br><span class=\"line\">\t\t\t\t\t\tif (err) &#123;</span><br><span class=\"line\">\t\t\t\t\t\t\treject(err);</span><br><span class=\"line\">\t\t\t\t\t\t&#125; else &#123;</span><br><span class=\"line\">\t\t\t\t\t\t\tresolve(msg);</span><br><span class=\"line\">\t\t\t\t\t\t&#125;</span><br><span class=\"line\">\t\t\t\t\t&#125;)</span><br><span class=\"line\">\t\t\t\t&#125;).then(function() &#123;</span><br><span class=\"line\">                    //如果promise返回成功, 就递归调用handleNext来处理it迭代器至完成</span><br><span class=\"line\">                    handleNext,</span><br><span class=\"line\"></span><br><span class=\"line\">                    //异常处理</span><br><span class=\"line\">                    function handleErr(err) &#123;</span><br><span class=\"line\">                        return Promise.resolve(</span><br><span class=\"line\">                            //处理异常</span><br><span class=\"line\">                            it.throw(err)</span><br><span class=\"line\">                        ).then(</span><br><span class=\"line\">                            //继续处理异常处理的结果</span><br><span class=\"line\">                            handleResult</span><br><span class=\"line\">                        )</span><br><span class=\"line\">                    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t\t\t\t&#125;)</span><br><span class=\"line\">\t\t\t&#125; else &#123;</span><br><span class=\"line\">                //否则就递归调用迭代器</span><br><span class=\"line\">                //通过promise处理next.value, 如果next.value是非promise对象就会直接进入then, 否则就等待promise回调then</span><br><span class=\"line\">                //这里的next.value一般都是异步处理, 例如ajax操作</span><br><span class=\"line\">                return Promise.resolve(next.value).then(</span><br><span class=\"line\">                    //如果promise返回成功, 就递归调用handleNext来处理it迭代器至完成</span><br><span class=\"line\">                    handleNext,</span><br><span class=\"line\">\t\t\t\t\t</span><br><span class=\"line\">                    //异常处理</span><br><span class=\"line\">                    function handleErr(err) &#123;</span><br><span class=\"line\">                        return Promise.resolve(</span><br><span class=\"line\">                            //处理异常</span><br><span class=\"line\">                            it.throw(err)</span><br><span class=\"line\">                        ).then(</span><br><span class=\"line\">                            //继续处理异常处理的结果</span><br><span class=\"line\">                            handleResult</span><br><span class=\"line\">                        )</span><br><span class=\"line\">                    &#125;</span><br><span class=\"line\">                );</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;)(next)</span><br><span class=\"line\">    &#125;)</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">co(test, 3000).then(function(res) &#123;</span><br><span class=\"line\">    console.log(&quot;res: &quot;,res)</span><br><span class=\"line\">&#125;);</span><br></pre></td></tr></table></figure>\n<blockquote>\n<p>上面是一个自动递归处理迭代器的方法, 方法类似co库</p>\n</blockquote>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">funcion *foo() &#123;</span><br><span class=\"line\">\tvar r1 = yield ajax(&apos;url1&apos;);</span><br><span class=\"line\">\tvar r2 = yield ajax(&apos;url2&apos;);</span><br><span class=\"line\"></span><br><span class=\"line\">\tvar r3 = yield ajax(r1+r2);</span><br><span class=\"line\">\treturn r3;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">co(foo);</span><br><span class=\"line\"></span><br><span class=\"line\">//可以优化为下面</span><br><span class=\"line\">funcion *foo() &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">\tvar p1 = ajax(&apos;url1&apos;);</span><br><span class=\"line\">\tvar p2 = ajax(&apos;url2&apos;);</span><br><span class=\"line\">\tvar r1 = yield p1</span><br><span class=\"line\">\tvar r2 = yield p2</span><br><span class=\"line\"></span><br><span class=\"line\">\tvar r3 = yield ajax(r1+r2);</span><br><span class=\"line\">\treturn r3;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">co(foo);</span><br><span class=\"line\">// 上面那方法可以理解如下</span><br><span class=\"line\">funcion *foo() &#123;</span><br><span class=\"line\">\tvar results = yield Promise.all([ajax(&apos;url1&apos;), ajax(&apos;url2)]);</span><br><span class=\"line\">\tvar r1 = results[0];</span><br><span class=\"line\">\tvar r2 = results[1];</span><br><span class=\"line\"></span><br><span class=\"line\">\tvar r3 = yield ajax(r1+r2);</span><br><span class=\"line\">\treturn r3;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">co(foo);</span><br></pre></td></tr></table></figure>\n<blockquote>\n<p>上面第一个demo, 按照迭代器的方式, 必须等r1的ajax返回结果后, 才会调用r2的ajax, 这样效率就会很低, 所以应该优化为下面那方法, 这样就可以先直接发送2个ajax请求并发, 处理结果使用迭代器</p>\n</blockquote>\n<h2 id=\"迭代器的polyfill\"><a href=\"#迭代器的polyfill\" class=\"headerlink\" title=\"迭代器的polyfill\"></a>迭代器的polyfill</h2><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">function *foo(url) &#123;</span><br><span class=\"line\">\t// STATE *1*</span><br><span class=\"line\">\ttry &#123;</span><br><span class=\"line\">\t\tconsole.log( &quot;requesting:&quot;, url );</span><br><span class=\"line\">\t\tvar TMP1 = request( url );</span><br><span class=\"line\"></span><br><span class=\"line\">\t\t// STATE *2*</span><br><span class=\"line\">\t\tvar val = yield TMP1;</span><br><span class=\"line\">\t\tconsole.log( val );</span><br><span class=\"line\">\t&#125; catch (e) &#123;</span><br><span class=\"line\">\t\t// STATE *3*</span><br><span class=\"line\">\t\tconsole.log( &quot;Oops:&quot;, err );</span><br><span class=\"line\">\t\treturn false;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">//polyfill 如下</span><br><span class=\"line\"></span><br><span class=\"line\">function foo(url) &#123;</span><br><span class=\"line\">\t// manage generator state</span><br><span class=\"line\">\tvar state;</span><br><span class=\"line\"></span><br><span class=\"line\">\t// generator-wide variable declarations</span><br><span class=\"line\">\tvar val;</span><br><span class=\"line\">\t</span><br><span class=\"line\">\tfunction process(v) &#123;</span><br><span class=\"line\">\t\tswitch (state) &#123;</span><br><span class=\"line\">\t\t\tcase 1: </span><br><span class=\"line\">\t\t\t\tconsole.log( &quot;requesting:&quot;, url );</span><br><span class=\"line\">\t\t\t\treturn request( url );  </span><br><span class=\"line\">\t\t\tcase 2:</span><br><span class=\"line\">\t\t\t\tval = v;</span><br><span class=\"line\">\t\t\t\tconsole.log( val );</span><br><span class=\"line\">\t\t\tcase 3:</span><br><span class=\"line\">\t\t\t\tvar err = v;</span><br><span class=\"line\">\t\t\t\tconsole.log( &quot;Oops:&quot;, err );</span><br><span class=\"line\">\t\t\t\treturn false;</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\treturn &#123;</span><br><span class=\"line\">\t\tnext: function(v) &#123;</span><br><span class=\"line\">\t\t\t// initial state</span><br><span class=\"line\">\t\t\tif (!state) &#123; </span><br><span class=\"line\">\t\t\t\tstate = 1;</span><br><span class=\"line\">\t\t\t\treturn &#123;</span><br><span class=\"line\">\t\t\t\t\tdone: false,</span><br><span class=\"line\">\t\t\t\t\tvalue: process()</span><br><span class=\"line\">\t\t\t\t&#125;;</span><br><span class=\"line\">\t\t\t// yield resumed successfully</span><br><span class=\"line\">\t\t\t&#125; else if (state == 1) &#123;</span><br><span class=\"line\">\t\t\t\tstate = 2;</span><br><span class=\"line\">\t\t\t\treturn &#123;</span><br><span class=\"line\">\t\t\t\t\tdone: true,</span><br><span class=\"line\">\t\t\t\t\tvalue: process( v )</span><br><span class=\"line\">\t\t\t\t&#125;;</span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\">\t\t\t// generator already completed</span><br><span class=\"line\">\t\t\telse &#123; </span><br><span class=\"line\">\t\t\t\treturn &#123;</span><br><span class=\"line\">\t\t\t\t\tdone: true,</span><br><span class=\"line\">\t\t\t\t\tvalue: undefined</span><br><span class=\"line\">\t\t\t\t&#125;;</span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\">\t\t&#125;,</span><br><span class=\"line\">\t\tthrow: function(e) &#123;</span><br><span class=\"line\">\t\t\t// the only explicit error handling is in </span><br><span class=\"line\">\t\t\t// state *1*</span><br><span class=\"line\">\t\t\tif (state == 1) &#123;</span><br><span class=\"line\">\t\t\t\tstate = 3; </span><br><span class=\"line\">\t\t\t\treturn &#123;</span><br><span class=\"line\">\t\t\t\t\tdone: true,</span><br><span class=\"line\">\t\t\t\t\tvalue: process( e )</span><br><span class=\"line\">\t\t\t\t&#125;;</span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\">\t\t\t// otherwise, an error won&apos;t be handled, </span><br><span class=\"line\">\t\t\t// so just throw it right back out</span><br><span class=\"line\">\t\t\telse &#123;</span><br><span class=\"line\">\t\t\t\tthrow e; </span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>"}