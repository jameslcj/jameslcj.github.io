{"tags":[{"name":"JavaScript Web Applications","permalink":"http://blog.hellolc.com/tags/JavaScript-Web-Applications/","url":"/async/tags/JavaScript Web Applications.json","count":2}],"categories":[],"url":"/async/posts/2018/02/03/ModelsAndData.json","date":1517641514000,"path":{"year":2018,"month":2,"day":3,"name":"ModelsAndData"},"title":"Models And Data","permalink":"http://blog.hellolc.com/2018/02/03/ModelsAndData/","content":"<h2 id=\"ORM\"><a href=\"#ORM\" class=\"headerlink\" title=\"ORM\"></a>ORM</h2><figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">Math</span>.guid = <span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\"></span>)</span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"string\">'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'</span>.replace(<span class=\"regexp\">/[xy]/g</span>, <span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\">c</span>) </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">var</span> r = <span class=\"built_in\">Math</span>.random()*<span class=\"number\">16</span>|<span class=\"number\">0</span>, v = c == <span class=\"string\">'x'</span> ? r : (r&amp;<span class=\"number\">0x3</span>|<span class=\"number\">0x8</span>);</span><br><span class=\"line\">        <span class=\"keyword\">return</span> v.toString(<span class=\"number\">16</span>); </span><br><span class=\"line\">    &#125;).toUpperCase();</span><br><span class=\"line\">&#125;;</span><br><span class=\"line\"><span class=\"keyword\">var</span> Model = &#123;</span><br><span class=\"line\">    <span class=\"comment\">//记录实例对象</span></span><br><span class=\"line\">    records: &#123;&#125;,</span><br><span class=\"line\">    inherited: <span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\"></span>)</span>&#123;&#125;,</span><br><span class=\"line\">    created: <span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\"></span>)</span>&#123;</span><br><span class=\"line\">        <span class=\"comment\">//让records不共享</span></span><br><span class=\"line\">        <span class=\"keyword\">this</span>.records = &#123;&#125;; </span><br><span class=\"line\">    &#125;,</span><br><span class=\"line\">    find: <span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\">id</span>)</span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">var</span> record = <span class=\"keyword\">this</span>.records[id];</span><br><span class=\"line\">        <span class=\"keyword\">if</span> ( !record ) <span class=\"keyword\">throw</span>(<span class=\"string\">\"Unknown record\"</span>); </span><br><span class=\"line\">        <span class=\"comment\">//每次返回都重新复制一个对象 防止修改影响到records里的数据</span></span><br><span class=\"line\">        <span class=\"keyword\">return</span> record.dup();</span><br><span class=\"line\">    &#125;,</span><br><span class=\"line\">    <span class=\"comment\">//实例所具有的方法</span></span><br><span class=\"line\">    prototype: &#123;</span><br><span class=\"line\">        newRecord: <span class=\"literal\">true</span>,</span><br><span class=\"line\">        init: <span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\">atts</span>) </span>&#123;</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (atts) <span class=\"keyword\">this</span>.load(atts);</span><br><span class=\"line\">        &#125;,</span><br><span class=\"line\">        load: <span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\">attributes</span>)</span>&#123; </span><br><span class=\"line\">            <span class=\"keyword\">for</span>(<span class=\"keyword\">var</span> name <span class=\"keyword\">in</span> attributes)</span><br><span class=\"line\">                <span class=\"keyword\">this</span>[name] = attributes[name]; </span><br><span class=\"line\">        &#125;,</span><br><span class=\"line\">        create: <span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\"></span>)</span>&#123;</span><br><span class=\"line\">            <span class=\"keyword\">if</span> ( !<span class=\"keyword\">this</span>.id ) <span class=\"keyword\">this</span>.id = <span class=\"built_in\">Math</span>.guid(); </span><br><span class=\"line\">            <span class=\"keyword\">this</span>.newRecord = <span class=\"literal\">false</span>; </span><br><span class=\"line\">            <span class=\"keyword\">this</span>.parent.records[<span class=\"keyword\">this</span>.id] = <span class=\"keyword\">this</span>.dup();</span><br><span class=\"line\">        &#125;,</span><br><span class=\"line\">        dup: <span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\"></span>)</span>&#123;</span><br><span class=\"line\">            <span class=\"keyword\">return</span> $.extend(<span class=\"literal\">true</span>, &#123;&#125;, <span class=\"keyword\">this</span>);</span><br><span class=\"line\">        &#125;,</span><br><span class=\"line\">        destroy: <span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\"></span>)</span>&#123;</span><br><span class=\"line\">            <span class=\"keyword\">delete</span> <span class=\"keyword\">this</span>.parent.records[<span class=\"keyword\">this</span>.id];</span><br><span class=\"line\">        &#125;,</span><br><span class=\"line\">        update: <span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\"></span>)</span>&#123;</span><br><span class=\"line\">            <span class=\"keyword\">this</span>.parent.records[<span class=\"keyword\">this</span>.id] = <span class=\"keyword\">this</span>.dup();</span><br><span class=\"line\">        &#125;,</span><br><span class=\"line\">        save: <span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\"></span>)</span>&#123;</span><br><span class=\"line\">            <span class=\"keyword\">this</span>.newRecord ? <span class=\"keyword\">this</span>.create() : <span class=\"keyword\">this</span>.update();</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;,</span><br><span class=\"line\">    create: <span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\"></span>)</span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">var</span> object = <span class=\"built_in\">Object</span>.create(<span class=\"keyword\">this</span>);</span><br><span class=\"line\">        object.parent = <span class=\"keyword\">this</span>;</span><br><span class=\"line\">        object.prototype = object.fn = <span class=\"built_in\">Object</span>.create(<span class=\"keyword\">this</span>.prototype);</span><br><span class=\"line\">        object.created(); </span><br><span class=\"line\">        <span class=\"keyword\">this</span>.inherited(object); </span><br><span class=\"line\">        <span class=\"keyword\">return</span> object;</span><br><span class=\"line\">    &#125;,</span><br><span class=\"line\">    init: <span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\"></span>)</span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">var</span> instance = <span class=\"built_in\">Object</span>.create(<span class=\"keyword\">this</span>.prototype); </span><br><span class=\"line\">        instance.parent = <span class=\"keyword\">this</span>; </span><br><span class=\"line\">        <span class=\"comment\">// console.log(\"init: \", instance.init)</span></span><br><span class=\"line\">        instance.init.apply(instance, <span class=\"built_in\">arguments</span>); </span><br><span class=\"line\">        <span class=\"keyword\">return</span> instance;</span><br><span class=\"line\">    &#125;,</span><br><span class=\"line\">    include: <span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\">o</span>)</span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">var</span> included = o.included; </span><br><span class=\"line\">        $.extend(<span class=\"keyword\">this</span>.prototype, o); </span><br><span class=\"line\">        <span class=\"keyword\">if</span> (included) included(<span class=\"keyword\">this</span>);</span><br><span class=\"line\">    &#125;,</span><br><span class=\"line\">    extend: <span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\">o</span>)</span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">var</span> extended = o.extended; </span><br><span class=\"line\">        $.extend(<span class=\"keyword\">this</span>, o);</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (extended) extended(<span class=\"keyword\">this</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//获取一个User model</span></span><br><span class=\"line\"><span class=\"keyword\">var</span> User = Model.create();</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//获取一个user1实例</span></span><br><span class=\"line\"><span class=\"keyword\">var</span> user1 = User.init();</span><br><span class=\"line\">user1.id = <span class=\"number\">1</span>;</span><br><span class=\"line\">user1.name = <span class=\"string\">'hello'</span>;</span><br><span class=\"line\">user1.save();</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//获取一个user2实例</span></span><br><span class=\"line\"><span class=\"keyword\">var</span> user2 = User.init(&#123;</span><br><span class=\"line\">    id: <span class=\"number\">2</span>,</span><br><span class=\"line\">    name: <span class=\"string\">'world'</span>,</span><br><span class=\"line\">&#125;);</span><br><span class=\"line\">user2.save();</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">var</span> Goods = Model.create();</span><br><span class=\"line\"><span class=\"keyword\">var</span> goods1 = Goods.init(&#123;</span><br><span class=\"line\">    id:<span class=\"number\">1</span>,</span><br><span class=\"line\">    name: <span class=\"string\">'computer'</span></span><br><span class=\"line\">&#125;)</span><br><span class=\"line\">goods1.save();</span><br><span class=\"line\"><span class=\"keyword\">var</span> goods2 = Goods.init(&#123;</span><br><span class=\"line\">    id:<span class=\"number\">2</span>,</span><br><span class=\"line\">    name: <span class=\"string\">'mobile'</span></span><br><span class=\"line\">&#125;)</span><br><span class=\"line\">goods2.save()</span><br></pre></td></tr></table></figure>"}