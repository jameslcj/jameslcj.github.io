{"tags":[{"name":"JavaScript设计模式与开发实践","permalink":"http://blog.hellolc.com/tags/JavaScript设计模式与开发实践/","url":"/async/tags/JavaScript设计模式与开发实践.json","count":1}],"categories":[],"url":"/async/posts/2018/02/23/JavaScript设计模式与开发实践.json","date":1519390489000,"path":{"year":2018,"month":2,"day":23,"name":"JavaScript设计模式与开发实践"},"title":"JavaScript设计模式与开发实践","permalink":"http://blog.hellolc.com/2018/02/23/JavaScript设计模式与开发实践/","content":"<h2 id=\"高阶函数实现AOP\"><a href=\"#高阶函数实现AOP\" class=\"headerlink\" title=\"高阶函数实现AOP\"></a>高阶函数实现AOP</h2><blockquote>\n<p>AOP(面向切面编程)的主要作用是把一些跟核心业务逻辑模块无关的功能抽离出来，这些 跟业务逻辑无关的功能通常包括日志统计、安全控制、异常处理等</p>\n</blockquote>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">Function</span>.prototype.before = <span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\"> beforefn </span>) </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">var</span> __self = <span class=\"keyword\">this</span>; <span class=\"comment\">// 保存原函数的引用</span></span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\"></span>)</span>&#123; <span class=\"comment\">// 返回包含了原函数和新函数的\"代理\"函数</span></span><br><span class=\"line\">        beforefn.apply( <span class=\"keyword\">this</span>, <span class=\"built_in\">arguments</span> ); <span class=\"comment\">// 执行新函数，修正 this</span></span><br><span class=\"line\">        <span class=\"keyword\">return</span> __self.apply( <span class=\"keyword\">this</span>, <span class=\"built_in\">arguments</span> );<span class=\"comment\">// 执行原函数</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"built_in\">Function</span>.prototype.after = <span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\"> afterfn </span>)</span>&#123; </span><br><span class=\"line\">    <span class=\"keyword\">var</span> __self = <span class=\"keyword\">this</span>;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\"></span>)</span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">var</span> ret = __self.apply( <span class=\"keyword\">this</span>, <span class=\"built_in\">arguments</span> ); <span class=\"comment\">//执行前面的函数</span></span><br><span class=\"line\">        afterfn.apply( <span class=\"keyword\">this</span>, <span class=\"built_in\">arguments</span> ); <span class=\"comment\">//调用最后的函数</span></span><br><span class=\"line\">        <span class=\"keyword\">return</span> ret;</span><br><span class=\"line\">    &#125; </span><br><span class=\"line\">&#125;;</span><br><span class=\"line\"><span class=\"keyword\">var</span> func = <span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\"></span>)</span>&#123; </span><br><span class=\"line\">    <span class=\"built_in\">console</span>.log( <span class=\"number\">2</span> );</span><br><span class=\"line\">&#125;;</span><br><span class=\"line\">func = func.before(<span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\"></span>)</span>&#123; </span><br><span class=\"line\">    <span class=\"built_in\">console</span>.log( <span class=\"number\">1</span> );</span><br><span class=\"line\">&#125;).after(<span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\"></span>)</span>&#123; </span><br><span class=\"line\">    <span class=\"built_in\">console</span>.log( <span class=\"number\">3</span> );</span><br><span class=\"line\">&#125;); </span><br><span class=\"line\">func();</span><br></pre></td></tr></table></figure>\n<h2 id=\"uncurrying\"><a href=\"#uncurrying\" class=\"headerlink\" title=\"uncurrying\"></a>uncurrying</h2><figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">Function</span>.prototype.uncurrying = <span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\"></span>)</span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">var</span> self = <span class=\"keyword\">this</span>; </span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\"></span>)</span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">var</span> obj = <span class=\"built_in\">Array</span>.prototype.shift.call( <span class=\"built_in\">arguments</span> );</span><br><span class=\"line\">        <span class=\"keyword\">return</span> self.apply( obj, <span class=\"built_in\">arguments</span> );</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;;</span><br><span class=\"line\"><span class=\"keyword\">var</span> push = <span class=\"built_in\">Array</span>.prototype.push.uncurrying();</span><br><span class=\"line\">(<span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\"></span>)</span>&#123;</span><br><span class=\"line\">    push( <span class=\"built_in\">arguments</span>, <span class=\"number\">4</span> );</span><br><span class=\"line\">    <span class=\"built_in\">console</span>.log( <span class=\"built_in\">arguments</span> ); <span class=\"comment\">// 输出:[1, 2, 3, 4]</span></span><br><span class=\"line\">&#125;)( <span class=\"number\">1</span>, <span class=\"number\">2</span>, <span class=\"number\">3</span> );</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//第二种实现</span></span><br><span class=\"line\"><span class=\"built_in\">Function</span>.prototype.uncurrying = <span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\"></span>)</span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">var</span> self = <span class=\"keyword\">this</span>; </span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\"></span>)</span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"built_in\">Function</span>.prototype.call.apply( self, <span class=\"built_in\">arguments</span> ); </span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;;</span><br></pre></td></tr></table></figure>\n<h2 id=\"函数节流\"><a href=\"#函数节流\" class=\"headerlink\" title=\"函数节流\"></a>函数节流</h2><blockquote>\n<p>一次性渲染太多影响性能, 所以分批进行渲染<br><figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">var</span> timeChunk = <span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\"> ary, fn, count </span>)</span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">var</span> obj, t;</span><br><span class=\"line\">    <span class=\"keyword\">var</span> len = ary.length; </span><br><span class=\"line\">    <span class=\"keyword\">var</span> start = <span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\"></span>)</span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">for</span>( <span class=\"keyword\">var</span> i = <span class=\"number\">0</span>; i &lt; <span class=\"built_in\">Math</span>.min( count || <span class=\"number\">1</span>, ary.length ); i++ )&#123; </span><br><span class=\"line\">            <span class=\"keyword\">var</span> obj = ary.shift();</span><br><span class=\"line\">            fn( obj );  </span><br><span class=\"line\">        &#125; </span><br><span class=\"line\">    &#125;;</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\"></span>)</span>&#123;</span><br><span class=\"line\">        t = setInterval(<span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\"></span>)</span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> ( ary.length === <span class=\"number\">0</span> )&#123; <span class=\"comment\">// 如果全部节点都已经被创建好</span></span><br><span class=\"line\">            <span class=\"keyword\">return</span> clearInterval( t ); &#125;</span><br><span class=\"line\">            start();</span><br><span class=\"line\">        &#125;, <span class=\"number\">200</span> ); <span class=\"comment\">// 分批执行的时间间隔，也可以用参数的形式传入</span></span><br><span class=\"line\">    &#125;; </span><br><span class=\"line\"> &#125;;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">var</span> ary = [];</span><br><span class=\"line\"><span class=\"keyword\">for</span> ( <span class=\"keyword\">var</span> i = <span class=\"number\">1</span>; i &lt;= <span class=\"number\">1000</span>; i++ )&#123; </span><br><span class=\"line\">    ary.push( i );</span><br><span class=\"line\">&#125;;</span><br><span class=\"line\"><span class=\"keyword\">var</span> renderFriendList = timeChunk( ary, <span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\"> n </span>)</span>&#123; </span><br><span class=\"line\">    <span class=\"keyword\">var</span> div = <span class=\"built_in\">document</span>.createElement( <span class=\"string\">'div'</span> ); </span><br><span class=\"line\">    div.innerHTML = n;</span><br><span class=\"line\">    <span class=\"built_in\">document</span>.body.appendChild( div );</span><br><span class=\"line\">&#125;, <span class=\"number\">8</span> ); </span><br><span class=\"line\">renderFriendList();</span><br></pre></td></tr></table></figure></p>\n</blockquote>\n<h2 id=\"单列模式\"><a href=\"#单列模式\" class=\"headerlink\" title=\"单列模式\"></a>单列模式</h2><figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">var</span> getSingle = <span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\"> fn </span>)</span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">var</span> result;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\"></span>)</span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> result || ( result = fn .apply(<span class=\"keyword\">this</span>, <span class=\"built_in\">arguments</span> ) );</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;;</span><br><span class=\"line\"><span class=\"keyword\">var</span> createLoginLayer = <span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\"></span>) </span>&#123;&#125;<span class=\"comment\">//创建登陆框的逻辑</span></span><br><span class=\"line\"><span class=\"keyword\">var</span> createSingleLoginLayer = getSingle( createLoginLayer );</span><br></pre></td></tr></table></figure>\n<h3 id=\"用单例模式代替once\"><a href=\"#用单例模式代替once\" class=\"headerlink\" title=\"用单例模式代替once\"></a>用单例模式代替once</h3><figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//让div的click事件只触发一次</span></span><br><span class=\"line\"><span class=\"keyword\">var</span> bindEvent = <span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\"></span>)</span>&#123;</span><br><span class=\"line\">    $( <span class=\"string\">'div'</span> ).one( <span class=\"string\">'click'</span>, <span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\"></span>)</span>&#123;</span><br><span class=\"line\">        alert ( <span class=\"string\">'click'</span> ); </span><br><span class=\"line\">    &#125;);</span><br><span class=\"line\">&#125;;</span><br><span class=\"line\"><span class=\"keyword\">var</span> render = <span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\"></span>)</span>&#123; </span><br><span class=\"line\">    <span class=\"built_in\">console</span>.log( <span class=\"string\">'开始渲染列表'</span> ); </span><br><span class=\"line\">    bindEvent();</span><br><span class=\"line\">&#125;;</span><br><span class=\"line\">render();</span><br><span class=\"line\">render();</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//下面利用单例模式实现</span></span><br><span class=\"line\"><span class=\"keyword\">var</span> bindEvent = getSingle(<span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\"></span>)</span>&#123; </span><br><span class=\"line\">    <span class=\"built_in\">document</span>.getElementById( <span class=\"string\">'div1'</span> ).onclick = <span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\"></span>)</span>&#123;</span><br><span class=\"line\">        alert ( <span class=\"string\">'click'</span> ); </span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"literal\">true</span>; </span><br><span class=\"line\">&#125;);</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">var</span> render = <span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\"></span>)</span>&#123; </span><br><span class=\"line\">    <span class=\"built_in\">console</span>.log( <span class=\"string\">'开始渲染列表'</span> ); </span><br><span class=\"line\">    bindEvent();</span><br><span class=\"line\">&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\">render(); </span><br><span class=\"line\">render();</span><br></pre></td></tr></table></figure>\n<h2 id=\"策略模式\"><a href=\"#策略模式\" class=\"headerlink\" title=\"策略模式\"></a>策略模式</h2><blockquote>\n<p>策略模式指的是定义一系 列的算法，把它们一个个封装起来。将不变的部分和变化的部分隔开是每个设计模式的主题，策 略模式也不例外，策略模式的目的就是将算法的使用与算法的实现分离开来。</p>\n</blockquote>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//案例</span></span><br><span class=\"line\"><span class=\"keyword\">var</span> calculateBonus = <span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\"> performanceLevel, salary </span>)</span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> ( performanceLevel === <span class=\"string\">'S'</span> )&#123; </span><br><span class=\"line\">        <span class=\"keyword\">return</span> salary * <span class=\"number\">4</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> ( performanceLevel === <span class=\"string\">'A'</span> )&#123; </span><br><span class=\"line\">        <span class=\"keyword\">return</span> salary * <span class=\"number\">3</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> ( performanceLevel === <span class=\"string\">'B'</span> )&#123; </span><br><span class=\"line\">        <span class=\"keyword\">return</span> salary * <span class=\"number\">2</span>;</span><br><span class=\"line\">    &#125; </span><br><span class=\"line\">&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\">calculateBonus( <span class=\"string\">'B'</span>, <span class=\"number\">20000</span> ); <span class=\"comment\">// 输出:40000</span></span><br><span class=\"line\">calculateBonus( <span class=\"string\">'S'</span>, <span class=\"number\">6000</span> ); <span class=\"comment\">// 输出:24000</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//使用策略模式</span></span><br><span class=\"line\"><span class=\"keyword\">var</span> strategies = &#123;</span><br><span class=\"line\">    <span class=\"string\">\"S\"</span>: <span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\"> salary </span>)</span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> salary * <span class=\"number\">4</span>; </span><br><span class=\"line\">    &#125;,</span><br><span class=\"line\">    <span class=\"string\">\"A\"</span>: <span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\"> salary </span>)</span>&#123; </span><br><span class=\"line\">        <span class=\"keyword\">return</span> salary * <span class=\"number\">3</span>;</span><br><span class=\"line\">    &#125;,</span><br><span class=\"line\">    <span class=\"string\">\"B\"</span>: <span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\"> salary </span>)</span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> salary * <span class=\"number\">2</span>; </span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;;</span><br><span class=\"line\"><span class=\"keyword\">var</span> calculateBonus = <span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\"> level, salary </span>)</span>&#123; </span><br><span class=\"line\">    <span class=\"keyword\">return</span> strategies[ level ]( salary );</span><br><span class=\"line\">&#125;;</span><br><span class=\"line\"><span class=\"built_in\">console</span>.log( calculateBonus( <span class=\"string\">'S'</span>, <span class=\"number\">20000</span> ) ); <span class=\"comment\">// 输出:80000 </span></span><br><span class=\"line\"><span class=\"built_in\">console</span>.log( calculateBonus( <span class=\"string\">'A'</span>, <span class=\"number\">10000</span> ) ); <span class=\"comment\">// 输出:30000</span></span><br></pre></td></tr></table></figure>\n<h2 id=\"代理模式\"><a href=\"#代理模式\" class=\"headerlink\" title=\"代理模式\"></a>代理模式</h2><blockquote>\n<p>代理模式包括许多小分类，在 JavaScript 开发中最常用的是虚拟代理和缓存代理</p>\n</blockquote>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//不用代理模式  下面代码只能实现预加载, 如果哪天不需要预加载了 整个代码都需要改变</span></span><br><span class=\"line\"><span class=\"keyword\">var</span> MyImage = (<span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\"></span>)</span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">var</span> imgNode = <span class=\"built_in\">document</span>.createElement( <span class=\"string\">'img'</span> ); </span><br><span class=\"line\">    <span class=\"built_in\">document</span>.body.appendChild( imgNode );</span><br><span class=\"line\">    <span class=\"keyword\">var</span> img = <span class=\"keyword\">new</span> Image;</span><br><span class=\"line\">    img.onload = <span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\"></span>)</span>&#123; </span><br><span class=\"line\">        imgNode.src = img.src;</span><br><span class=\"line\">    &#125;;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> &#123;</span><br><span class=\"line\">        setSrc: <span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\"> src </span>)</span>&#123;</span><br><span class=\"line\">            imgNode.src = <span class=\"string\">'file:// /C:/Users/svenzeng/Desktop/loading.gif'</span>;</span><br><span class=\"line\">            img.src = src; </span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125; </span><br><span class=\"line\">&#125;)();</span><br><span class=\"line\"></span><br><span class=\"line\">MyImage.setSrc( <span class=\"string\">'http:// imgcache.qq.com/music/photo/k/000GGDys0yA0Nk.jpg'</span> );</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//使用代理模式 </span></span><br><span class=\"line\"><span class=\"keyword\">var</span> myImage = (<span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\"></span>)</span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">var</span> imgNode = <span class=\"built_in\">document</span>.createElement( <span class=\"string\">'img'</span> ); </span><br><span class=\"line\">    <span class=\"built_in\">document</span>.body.appendChild( imgNode );</span><br><span class=\"line\">    <span class=\"keyword\">return</span> &#123;</span><br><span class=\"line\">        setSrc: <span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\"> src </span>)</span>&#123;</span><br><span class=\"line\">        imgNode.src = src; &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;)();</span><br><span class=\"line\"><span class=\"keyword\">var</span> proxyImage = (<span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\"></span>)</span>&#123; </span><br><span class=\"line\">    <span class=\"keyword\">var</span> img = <span class=\"keyword\">new</span> Image; </span><br><span class=\"line\">    img.onload = <span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\"></span>)</span>&#123;</span><br><span class=\"line\">        myImage.setSrc( <span class=\"keyword\">this</span>.src ); </span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> &#123;</span><br><span class=\"line\">        setSrc: <span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\"> src </span>)</span>&#123;</span><br><span class=\"line\">            myImage.setSrc( <span class=\"string\">'file:// /C:/Users/svenzeng/Desktop/loading.gif'</span> );</span><br><span class=\"line\">            img.src = src; </span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125; </span><br><span class=\"line\">&#125;)();</span><br><span class=\"line\"></span><br><span class=\"line\">proxyImage.setSrc( <span class=\"string\">'http:// imgcache.qq.com/music/photo/k/000GGDys0yA0Nk.jpg'</span> );</span><br></pre></td></tr></table></figure>\n<h3 id=\"缓存代理\"><a href=\"#缓存代理\" class=\"headerlink\" title=\"缓存代理\"></a>缓存代理</h3><figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">/**************** 计算乘积 *****************/</span> </span><br><span class=\"line\"><span class=\"keyword\">var</span> mult = <span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\"></span>)</span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">var</span> a = <span class=\"number\">1</span>;</span><br><span class=\"line\">    <span class=\"keyword\">for</span> (<span class=\"keyword\">var</span> i = <span class=\"number\">0</span>, l = <span class=\"built_in\">arguments</span>.length; i &lt; l; i ++) &#123;</span><br><span class=\"line\">        a *= <span class=\"built_in\">arguments</span>[i];</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">return</span> a;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"> <span class=\"comment\">/**************** 计算加和 *****************/</span></span><br><span class=\"line\"><span class=\"keyword\">var</span> plus = <span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\"></span>)</span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">var</span> a = <span class=\"number\">1</span>;</span><br><span class=\"line\">    <span class=\"keyword\">for</span> (<span class=\"keyword\">var</span> i = <span class=\"number\">0</span>, l = <span class=\"built_in\">arguments</span>.length; i &lt; l; i ++) &#123;</span><br><span class=\"line\">        a += <span class=\"built_in\">arguments</span>[i];</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">return</span> a;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">/**************** 创建缓存代理的工厂 *****************/</span> </span><br><span class=\"line\"><span class=\"keyword\">var</span> createProxyFactory = <span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\"> fn </span>)</span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">var</span> cache = &#123;&#125;;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\"></span>)</span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">var</span> args = <span class=\"built_in\">Array</span>.prototype.join.call( <span class=\"built_in\">arguments</span>, <span class=\"string\">','</span> );</span><br><span class=\"line\">        <span class=\"keyword\">if</span> ( args <span class=\"keyword\">in</span> cache )&#123;</span><br><span class=\"line\">            <span class=\"keyword\">return</span> cache[ args ]; </span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> cache[ args ] = fn.apply( <span class=\"keyword\">this</span>, <span class=\"built_in\">arguments</span> ); </span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">var</span> proxyMult = createProxyFactory( mult ), </span><br><span class=\"line\">proxyPlus = createProxyFactory( plus );</span><br><span class=\"line\"></span><br><span class=\"line\">alert ( proxyMult( <span class=\"number\">1</span>, <span class=\"number\">2</span>, <span class=\"number\">3</span>, <span class=\"number\">4</span> ) );<span class=\"comment\">//输出:24</span></span><br><span class=\"line\">alert ( proxyPlus( <span class=\"number\">1</span>, <span class=\"number\">2</span>, <span class=\"number\">3</span>, <span class=\"number\">4</span> ) );<span class=\"comment\">//输出:10</span></span><br></pre></td></tr></table></figure>\n<h3 id=\"状态模式\"><a href=\"#状态模式\" class=\"headerlink\" title=\"状态模式\"></a>状态模式</h3><blockquote>\n<p>传统的状态模式</p>\n</blockquote>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br><span class=\"line\">138</span><br><span class=\"line\">139</span><br><span class=\"line\">140</span><br><span class=\"line\">141</span><br><span class=\"line\">142</span><br><span class=\"line\">143</span><br><span class=\"line\">144</span><br><span class=\"line\">145</span><br><span class=\"line\">146</span><br><span class=\"line\">147</span><br><span class=\"line\">148</span><br><span class=\"line\">149</span><br><span class=\"line\">150</span><br><span class=\"line\">151</span><br><span class=\"line\">152</span><br><span class=\"line\">153</span><br><span class=\"line\">154</span><br><span class=\"line\">155</span><br><span class=\"line\">156</span><br><span class=\"line\">157</span><br><span class=\"line\">158</span><br><span class=\"line\">159</span><br><span class=\"line\">160</span><br><span class=\"line\">161</span><br><span class=\"line\">162</span><br><span class=\"line\">163</span><br><span class=\"line\">164</span><br><span class=\"line\">165</span><br><span class=\"line\">166</span><br><span class=\"line\">167</span><br><span class=\"line\">168</span><br><span class=\"line\">169</span><br><span class=\"line\">170</span><br><span class=\"line\">171</span><br><span class=\"line\">172</span><br><span class=\"line\">173</span><br><span class=\"line\">174</span><br><span class=\"line\">175</span><br><span class=\"line\">176</span><br><span class=\"line\">177</span><br><span class=\"line\">178</span><br><span class=\"line\">179</span><br><span class=\"line\">180</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">window</span>.external.upload = <span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\">state</span>) </span>&#123;</span><br><span class=\"line\">    <span class=\"built_in\">console</span>.log(state);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">var</span> plugin = (<span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\"></span>) </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">var</span> plugin = <span class=\"built_in\">document</span>.createElement( <span class=\"string\">'embed'</span> ); </span><br><span class=\"line\">    plugin.style.display = <span class=\"string\">'none'</span>;</span><br><span class=\"line\">    plugin.type = <span class=\"string\">'application/txftn-webkit'</span>; </span><br><span class=\"line\"></span><br><span class=\"line\">    plugin.sign = <span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\"></span>) </span>&#123;</span><br><span class=\"line\">        <span class=\"built_in\">console</span>.log(<span class=\"string\">\"开始文件扫描\"</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    plugin.pause = <span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\"></span>) </span>&#123;</span><br><span class=\"line\">        <span class=\"built_in\">console</span>.log(<span class=\"string\">\"暂停文件扫描\"</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    plugin.uploading = <span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\"></span>) </span>&#123;</span><br><span class=\"line\">        <span class=\"built_in\">console</span>.log(<span class=\"string\">\"开始文件上传\"</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    plugin.del = <span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\"></span>) </span>&#123;</span><br><span class=\"line\">        <span class=\"built_in\">console</span>.log(<span class=\"string\">\"删除文件上传\"</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    plugin.done = <span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\"></span>) </span>&#123;</span><br><span class=\"line\">        <span class=\"built_in\">console</span>.log(<span class=\"string\">\"文件上传完成\"</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"built_in\">document</span>.body.appendChild( plugin );</span><br><span class=\"line\">    <span class=\"keyword\">return</span> plugin;</span><br><span class=\"line\">&#125;)();</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">var</span> Upload = <span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\"> fileName </span>)</span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">this</span>.plugin = plugin;</span><br><span class=\"line\">    <span class=\"keyword\">this</span>.fileName = fileName;</span><br><span class=\"line\">    <span class=\"keyword\">this</span>.button1 = <span class=\"literal\">null</span>;</span><br><span class=\"line\">    <span class=\"keyword\">this</span>.button2 = <span class=\"literal\">null</span>;</span><br><span class=\"line\">    <span class=\"keyword\">this</span>.signState = <span class=\"keyword\">new</span> SignState( <span class=\"keyword\">this</span> ); </span><br><span class=\"line\">    <span class=\"keyword\">this</span>.uploadingState = <span class=\"keyword\">new</span> UploadingState( <span class=\"keyword\">this</span> );</span><br><span class=\"line\">    <span class=\"keyword\">this</span>.pauseState = <span class=\"keyword\">new</span> PauseState(<span class=\"keyword\">this</span>);</span><br><span class=\"line\">    <span class=\"keyword\">this</span>.doneState = <span class=\"keyword\">new</span> DoneState(<span class=\"keyword\">this</span>);</span><br><span class=\"line\">    <span class=\"keyword\">this</span>.errorState = <span class=\"keyword\">new</span> ErrorState(<span class=\"keyword\">this</span>);</span><br><span class=\"line\">    <span class=\"keyword\">this</span>.currState = <span class=\"keyword\">this</span>.signState;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">Upload.prototype.init = <span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\"></span>)</span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">var</span> that = <span class=\"keyword\">this</span>;</span><br><span class=\"line\">    <span class=\"keyword\">this</span>.dom = <span class=\"built_in\">document</span>.createElement( <span class=\"string\">'div'</span> ); </span><br><span class=\"line\">    <span class=\"keyword\">this</span>.dom.innerHTML = <span class=\"string\">'&lt;span&gt;文件名称:'</span> + <span class=\"keyword\">this</span>.fileName +<span class=\"string\">'&lt;/span&gt; \\</span></span><br><span class=\"line\"><span class=\"string\">        &lt;button data-action=\"button1\"&gt;扫描中&lt;/button&gt; \\</span></span><br><span class=\"line\"><span class=\"string\">        &lt;button data-action=\"button2\"&gt;删除&lt;/button&gt;'</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"built_in\">document</span>.body.appendChild( <span class=\"keyword\">this</span>.dom );</span><br><span class=\"line\">    <span class=\"keyword\">this</span>.button1 = <span class=\"keyword\">this</span>.dom.querySelector( <span class=\"string\">'[data-action=\"button1\"]'</span> ); </span><br><span class=\"line\">    <span class=\"keyword\">this</span>.button2 = <span class=\"keyword\">this</span>.dom.querySelector( <span class=\"string\">'[data-action=\"button2\"]'</span> );</span><br><span class=\"line\">    <span class=\"keyword\">this</span>.bindEvent(); </span><br><span class=\"line\">&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\">Upload.prototype.bindEvent = <span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\"></span>)</span>&#123; </span><br><span class=\"line\">    <span class=\"keyword\">var</span> self = <span class=\"keyword\">this</span>; </span><br><span class=\"line\">    <span class=\"keyword\">this</span>.button1.onclick = <span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\"></span>)</span>&#123;</span><br><span class=\"line\">        self.currState.clickHandler1(); </span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">this</span>.button2.onclick = <span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\"></span>)</span>&#123; </span><br><span class=\"line\">        self.currState.clickHandler2();</span><br><span class=\"line\">    &#125; </span><br><span class=\"line\">&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\">Upload.prototype.sign = <span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\"></span>)</span>&#123; </span><br><span class=\"line\">    <span class=\"keyword\">this</span>.plugin.sign(); </span><br><span class=\"line\">    <span class=\"keyword\">this</span>.currState = <span class=\"keyword\">this</span>.signState;</span><br><span class=\"line\">&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\">Upload.prototype.uploading = <span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\"></span>)</span>&#123; </span><br><span class=\"line\">    <span class=\"keyword\">this</span>.button1.innerHTML = <span class=\"string\">'正在上传, 点击暂停'</span>; </span><br><span class=\"line\">    <span class=\"keyword\">this</span>.plugin.uploading();</span><br><span class=\"line\">    <span class=\"keyword\">this</span>.currState = <span class=\"keyword\">this</span>.uploadingState;</span><br><span class=\"line\">&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\">Upload.prototype.pause = <span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\"></span>)</span>&#123; </span><br><span class=\"line\">    <span class=\"keyword\">this</span>.button1.innerHTML = <span class=\"string\">'已暂停, 点击继续上传'</span>; </span><br><span class=\"line\">    <span class=\"keyword\">this</span>.plugin.pause();</span><br><span class=\"line\">    <span class=\"keyword\">this</span>.currState = <span class=\"keyword\">this</span>.pauseState;</span><br><span class=\"line\">&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\">Upload.prototype.done = <span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\"></span>)</span>&#123; </span><br><span class=\"line\">    <span class=\"keyword\">this</span>.button1.innerHTML = <span class=\"string\">'上传完成'</span>; </span><br><span class=\"line\">    <span class=\"keyword\">this</span>.plugin.done();</span><br><span class=\"line\">    <span class=\"keyword\">this</span>.currState = <span class=\"keyword\">this</span>.doneState;</span><br><span class=\"line\">&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\">Upload.prototype.error = <span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\"></span>)</span>&#123; </span><br><span class=\"line\">    <span class=\"keyword\">this</span>.button1.innerHTML = <span class=\"string\">'上传失败'</span>; </span><br><span class=\"line\">    <span class=\"keyword\">this</span>.currState = <span class=\"keyword\">this</span>.errorState;</span><br><span class=\"line\">&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\">Upload.prototype.del = <span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\"></span>)</span>&#123; </span><br><span class=\"line\">    <span class=\"keyword\">this</span>.plugin.del();</span><br><span class=\"line\">    <span class=\"keyword\">this</span>.dom.parentNode.removeChild( <span class=\"keyword\">this</span>.dom );</span><br><span class=\"line\">&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">var</span> StateFactory = (<span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\"></span>) </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">var</span> State = <span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\"></span>) </span>&#123;&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\">    State.prototype.clickHandler1 = <span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\"></span>) </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> <span class=\"built_in\">Error</span>(<span class=\"string\">\"子类必须重写父类的clickHandler1 方法\"</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    State.prototype.clickHandler2 = <span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\"></span>) </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> <span class=\"built_in\">Error</span>(<span class=\"string\">\"子类必须重写父类的clickHandler2 方法\"</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\">param</span>) </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">var</span> F = <span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\"> uploadObj </span>)</span>&#123; </span><br><span class=\"line\">            <span class=\"keyword\">this</span>.uploadObj = uploadObj;</span><br><span class=\"line\">        &#125;;</span><br><span class=\"line\">        F.prototype = <span class=\"keyword\">new</span> State();</span><br><span class=\"line\">        <span class=\"keyword\">for</span>(<span class=\"keyword\">var</span> i <span class=\"keyword\">in</span> param)&#123; </span><br><span class=\"line\">            F.prototype[ i ] = param[ i ];</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> F;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;)</span><br><span class=\"line\"><span class=\"keyword\">var</span> SignState = StateFactory(&#123;</span><br><span class=\"line\">    clickHandler1: <span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\"></span>)</span>&#123;</span><br><span class=\"line\">        <span class=\"built_in\">console</span>.log( <span class=\"string\">'扫描中, 点击无效...'</span> );</span><br><span class=\"line\">    &#125;,</span><br><span class=\"line\">    clickHandler2: <span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\"></span>)</span>&#123;</span><br><span class=\"line\">        <span class=\"built_in\">console</span>.log( <span class=\"string\">'文件正在上传中, 不能删除'</span> ); </span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;);</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">var</span> UploadingState = StateFactory(&#123;</span><br><span class=\"line\">    clickHandler1: <span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\"></span>)</span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.uploadObj.pause();</span><br><span class=\"line\">    &#125;,</span><br><span class=\"line\">    clickHandler2: <span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\"></span>)</span>&#123;</span><br><span class=\"line\">        <span class=\"built_in\">console</span>.log( <span class=\"string\">'文件正在上传中, 不能删除'</span> ); </span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;);</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">var</span> PauseState = StateFactory(&#123;</span><br><span class=\"line\">    clickHandler1: <span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\"></span>)</span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.uploadObj.uploading();</span><br><span class=\"line\">    &#125;,</span><br><span class=\"line\">    clickHandler2: <span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\"></span>)</span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.uploadObj.del();  </span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;);</span><br><span class=\"line\"><span class=\"keyword\">var</span> DoneState = StateFactory(&#123;</span><br><span class=\"line\">    clickHandler1: <span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\"></span>)</span>&#123;</span><br><span class=\"line\">        <span class=\"built_in\">console</span>.log( <span class=\"string\">'文件上传上传, 点击无效'</span> );</span><br><span class=\"line\">    &#125;,</span><br><span class=\"line\">    clickHandler2: <span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\"></span>)</span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.uploadObj.del(); </span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;);</span><br><span class=\"line\"><span class=\"keyword\">var</span> ErrorState = StateFactory(&#123;</span><br><span class=\"line\">    clickHandler1: <span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\"></span>)</span>&#123;</span><br><span class=\"line\">        <span class=\"built_in\">console</span>.log( <span class=\"string\">'文件上传失败, 点击无效'</span> );</span><br><span class=\"line\">    &#125;,</span><br><span class=\"line\">    clickHandler2: <span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\"></span>)</span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.uploadObj.del(); </span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;);</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">var</span> uploadObj = <span class=\"keyword\">new</span> Upload( <span class=\"string\">'JavaScript          '</span> ); </span><br><span class=\"line\">uploadObj.init();</span><br><span class=\"line\"><span class=\"built_in\">window</span>.external.upload = <span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\"> state </span>)</span>&#123; </span><br><span class=\"line\">    uploadObj[ state ]();</span><br><span class=\"line\">&#125;;</span><br><span class=\"line\"><span class=\"built_in\">window</span>.external.upload( <span class=\"string\">'sign'</span> );</span><br><span class=\"line\"></span><br><span class=\"line\">setTimeout(<span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\"></span>)</span>&#123; </span><br><span class=\"line\">    <span class=\"built_in\">window</span>.external.upload( <span class=\"string\">'uploading'</span> );</span><br><span class=\"line\">&#125;, <span class=\"number\">1000</span> );</span><br><span class=\"line\"></span><br><span class=\"line\">setTimeout(<span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\"></span>)</span>&#123; </span><br><span class=\"line\">    <span class=\"built_in\">window</span>.external.upload( <span class=\"string\">'done'</span> );</span><br><span class=\"line\">&#125;, <span class=\"number\">5000</span> );</span><br></pre></td></tr></table></figure>\n<h4 id=\"JavaScript版本的状态模式\"><a href=\"#JavaScript版本的状态模式\" class=\"headerlink\" title=\"JavaScript版本的状态模式\"></a>JavaScript版本的状态模式</h4><figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">var</span> delegate = <span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\">client, delegation</span>) </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> &#123;</span><br><span class=\"line\">        buttonWasPressed: <span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\"></span>) </span>&#123;</span><br><span class=\"line\">            <span class=\"keyword\">return</span> delegation.buttonWasPressed.apply(client, <span class=\"built_in\">arguments</span>);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">var</span> FSM = &#123;</span><br><span class=\"line\">    off: &#123;</span><br><span class=\"line\">        buttonWasPressed: <span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\"></span>) </span>&#123;</span><br><span class=\"line\">            <span class=\"built_in\">console</span>.log(<span class=\"string\">\"关灯\"</span>);</span><br><span class=\"line\">            <span class=\"keyword\">this</span>.button.innerHTML = <span class=\"string\">\"下一次按我是开灯\"</span>;</span><br><span class=\"line\">            <span class=\"keyword\">this</span>.currState = <span class=\"keyword\">this</span>.onState;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;,</span><br><span class=\"line\">    on: &#123;</span><br><span class=\"line\">        buttonWasPressed: <span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\"></span>) </span>&#123;</span><br><span class=\"line\">            <span class=\"built_in\">console</span>.log(<span class=\"string\">\"开灯\"</span>);</span><br><span class=\"line\">            <span class=\"keyword\">this</span>.button.innerHTML = <span class=\"string\">\"下一次按我是关灯\"</span>;</span><br><span class=\"line\">            <span class=\"keyword\">this</span>.currState = <span class=\"keyword\">this</span>.offState;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">var</span> Light = <span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\"></span>) </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">this</span>.offState = delegate(<span class=\"keyword\">this</span>, FSM.off);</span><br><span class=\"line\">    <span class=\"keyword\">this</span>.onState = delegate(<span class=\"keyword\">this</span>, FSM.on);</span><br><span class=\"line\">    <span class=\"keyword\">this</span>.currState = <span class=\"keyword\">this</span>.offState;</span><br><span class=\"line\">    <span class=\"keyword\">this</span>.button = <span class=\"literal\">null</span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">Light.prototype.init = <span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\"></span>) </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">var</span> button = <span class=\"built_in\">document</span>.createElement(<span class=\"string\">\"button\"</span>),</span><br><span class=\"line\">        self = <span class=\"keyword\">this</span>;</span><br><span class=\"line\">    button.innerHTML = <span class=\"string\">\"已关灯\"</span>;</span><br><span class=\"line\">    <span class=\"keyword\">this</span>.button = <span class=\"built_in\">document</span>.body.applyChild(button);</span><br><span class=\"line\">    <span class=\"keyword\">this</span>.button.onclick = <span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\"></span>) </span>&#123;</span><br><span class=\"line\">        self.currState.buttonWasPressed();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">var</span> light = <span class=\"keyword\">new</span> Light();</span><br><span class=\"line\">light.init();</span><br></pre></td></tr></table></figure>"}